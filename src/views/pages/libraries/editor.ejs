<!-- Full Screen Container -->
<div class="fixed inset-0 bg-background z-50 flex flex-col">
  
  <!-- Header avec fermeture -->
  <div class="flex items-center gap-4 px-6 py-4 bg-card border-b border-border">
    <div class="flex-1">
      <p class="text-sm text-muted">√âditeur IA</p>
      <h1 class="text-xl font-bold"><%= fileName %></h1>
    </div>
    <span class="px-3 py-1.5 rounded-full bg-purple-100 text-purple-700 text-xs font-semibold">
      ‚ú® Mode Magic
    </span>
    <button onclick="refreshPreview()" class="p-2 rounded-xl hover:bg-background transition" title="Rafra√Æchir la pr√©visualisation">
      <svg class="w-5 h-5 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
    </button>
    <a href="/libraries/<%= library.id %>" class="p-2 rounded-xl hover:bg-background transition" title="Fermer l'√©diteur">
      <svg class="w-6 h-6 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </a>
  </div>

  <!-- Main Content -->
  <div class="flex-1 flex overflow-hidden">
    
    <!-- Left Panel: AI Prompt -->
    <div class="w-96 bg-card border-r border-border p-6 flex flex-col">
      <div class="mb-4">
        <h2 class="text-lg font-semibold mb-2">Assistant IA</h2>
        <p class="text-sm text-muted">D√©crivez les modifications que vous souhaitez apporter √† cette page.</p>
      </div>

      <!-- Conversation History -->
      <div id="conversation-history" class="flex-1 bg-background rounded-xl border border-border p-4 mb-4 overflow-y-auto space-y-3">
        <div class="text-center text-muted text-sm py-8">
          <svg class="w-12 h-12 mx-auto mb-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
          </svg>
          <p>Commencez par d√©crire ce que vous voulez modifier</p>
        </div>
      </div>

      <!-- Prompt Input -->
      <div class="space-y-3">
        <textarea 
          id="ai-prompt" 
          rows="4" 
          placeholder="Ex: Change la couleur de fond en bleu marine et agrandis le titre principal..."
          class="w-full bg-background border border-border rounded-xl px-4 py-3 outline-none focus:border-primary focus:ring-2 focus:ring-primary/10 resize-none"
        ></textarea>
        
        <div class="flex items-center gap-3">
          <button 
            onclick="sendPrompt()" 
            class="flex-1 px-6 py-3 rounded-xl bg-primary text-white font-semibold hover:bg-primary/90 transition disabled:opacity-50 disabled:cursor-not-allowed"
            id="send-btn">
            <span class="flex items-center justify-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
              </svg>
              Magic
            </span>
          </button>
          
          <button 
            onclick="clearConversation()" 
            class="px-4 py-3 rounded-xl border border-border hover:bg-background transition"
            title="Nouvelle conversation">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Right Panel: Preview -->
    <div class="flex-1 flex flex-col bg-card">
      <div class="flex-1 overflow-hidden">
        <iframe 
          id="preview-frame" 
          src="<%= previewUrl %>" 
          class="w-full h-full"
          sandbox="allow-scripts allow-same-origin"
          title="Pr√©visualisation HTML">
        </iframe>
      </div>
    </div>
    
  </div>
</div>

<script>
const conversationHistory = document.getElementById('conversation-history');
const promptInput = document.getElementById('ai-prompt');
const sendBtn = document.getElementById('send-btn');

function sendPrompt() {
  const prompt = promptInput.value.trim();
  if (!prompt) return;
  
  // Afficher le message de l'utilisateur
  addMessage('user', prompt);
  promptInput.value = '';
  
  // Simuler une r√©ponse de l'IA (pour l'instant)
  sendBtn.disabled = true;
  sendBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Traitement...</span>';
  
  setTimeout(() => {
    addMessage('assistant', 'üîÆ L\'IA n\'est pas encore connect√©e. Cette fonctionnalit√© sera impl√©ment√©e prochainement avec un service LLM pour modifier automatiquement votre HTML.');
    sendBtn.disabled = false;
    sendBtn.innerHTML = '<span class="flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/></svg> Magic</span>';
  }, 1500);
}

function addMessage(role, content) {
  // Retirer le message de bienvenue si pr√©sent
  const welcome = conversationHistory.querySelector('.text-center');
  if (welcome) welcome.remove();
  
  const messageDiv = document.createElement('div');
  messageDiv.className = role === 'user' 
    ? 'bg-primary text-white rounded-xl p-3 ml-8' 
    : 'bg-purple-50 text-primary rounded-xl p-3 mr-8';
  
  messageDiv.innerHTML = `
    <div class="flex items-start gap-2">
      <div class="flex-1">
        <p class="text-xs font-semibold mb-1 ${role === 'user' ? 'text-white/80' : 'text-muted'}">${role === 'user' ? 'Vous' : '‚ú® Assistant IA'}</p>
        <p class="text-sm">${content}</p>
      </div>
    </div>
  `;
  
  conversationHistory.appendChild(messageDiv);
  conversationHistory.scrollTop = conversationHistory.scrollHeight;
}

function clearConversation() {
  conversationHistory.innerHTML = `
    <div class="text-center text-muted text-sm py-8">
      <svg class="w-12 h-12 mx-auto mb-3 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
      </svg>
      <p>Commencez par d√©crire ce que vous voulez modifier</p>
    </div>
  `;
}

function refreshPreview() {
  const iframe = document.getElementById('preview-frame');
  const separator = iframe.src.includes('?') ? '&' : '?';
  iframe.src = iframe.src + separator + '_t=' + Date.now();
}

// Support pour Enter (avec Shift+Enter pour nouvelle ligne)
promptInput.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendPrompt();
  }
});
</script>
